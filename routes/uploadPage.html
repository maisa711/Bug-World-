<!DOCTYPE html>
<html>

<head>
  <title>File Upload Page</title>
  <link rel="stylesheet" type="text/css" href="../css/uploadPage.css" />
  <link rel="stylesheet" type="text/css" href="../css/app.css" />
  <script src="https://kit.fontawesome.com/19094358f0.js" crossorigin="anonymous"></script>
</head>

<body>
  <section class="header">
    <headtext>Upload files to create your own</headtext>
    <a href="uploadPage.html">
      <headerlogo><img src="buglogo.svg"></headerlogo>
    </a>
  </section>
  <section class="formsection">

    <form action="mainPage.html" method="post">
      <div class="mainDiv">
        <div class="inpDiv">
          <label for="divfile1">Please upload the world map:</label>
          <div class="uploadFile" id="divfile1">
            <label for="map">
              <i class="fa-solid fa-file-arrow-up fa-2x"></i>
            </label>
            <input id="map" type="file" onchange="SaveFile(this)" />
            <section id="errsection1" class="errsection1">
              <div id="error-message" style="display:none">
              <i class="fa-solid fa-circle-xmark fa-2x"></i>
              <div id="errortxt">Error in file</div></div>
              </section>
              <section id="successsection1" class="successsection1">
                <div id="success-message" style="display:none">
                <i class="fa-solid fa-circle-check fa-2x"></i>
                <div id="successtxt">0 errors detected.</div></div>
                </section>
          </div>
        </div>

        <div class="inpDiv">
          <label for="divfile2">Please upload the bug code 1:</label>
          <div class="uploadFile" id="divfile2">
            <label for="bugCode1">
              <i class="fa-solid fa-file-arrow-up fa-2x"></i>
            </label>

            <input id="bugCode1" type="file" onchange="SaveFile(this)" />
          </div>
        </div>

        <div class="inpDiv">
          <label for="divfile3">Please upload the bug code 2:</label>
          <div class="uploadFile" id="divfile3">
            <label for="bugCode2">
              <i class="fa-solid fa-file-arrow-up fa-2x"></i>
            </label>

            <input id="bugCode2" type="file" onchange="SaveFile(this)" />
          </div>
        </div>

        <div class="inpDiv">
          <label for="numIterations">Please enter the number of iterations:</label>
          <input type="number" id="numIterations" onchange="saveIterations(this)" />
        </div>

        <div class="inpDiv">
          <label for="actLog">Do you want to log the results of the session:
          </label>
          <input type="checkbox" id="actLog" onchange="saveLog(this)" />
        </div>

        <button type="submit" class="upBtn">Upload Files</button>
      </div>
    </form>

    <script>

      function SaveFile(inp) {
        const errorMessage = document.getElementById('error-message');
        const errortxt= document.getElementById('errortxt');
        const successMessage = document.getElementById('success-message');
        const file = inp.files[0];
        // create a new FileReader object
        const reader = new FileReader();

        // add an event listener to deal with the file when the reader is done
        reader.addEventListener(
          "load",

          function (event) {
            // this will then display a text file
            localStorage.setItem(inp.id, reader.result); // save contents to localStorage
            const uploadedFileContents = localStorage.getItem(inp.id);
            console.log(uploadedFileContents);
            var text = event.target.result;
            const lines = text.split("\n");
            var errortext = "An error occured";
            const a = parseInt(lines[1]); //height or num of rows
            const b = parseInt(lines[0]);  //width or num of column
            var plusno = 0;
            var minusno = 0;
            let plusFound = false;
            let minusFound = false;
            let hasError = false;
            const numLinesAfterSecondLine = lines.length - 2;
            // Verify number of lines after the second line
            if (numLinesAfterSecondLine == a) {
              console.log("correct number of rows");
            } else {
              console.log("incorrect number of rows");
              errortext = "Incorrect height. Correct and upload again";
            }
            for (let i = 2; i < lines.length; i++) {
              const line = lines[i].trim(); // Remove leading/trailing whitespaces

              // Verify first and last character of line is #
              if (line[0] !== "#" || line[line.length - 1] !== "#") {
                console.log("no outer border");
                errortext = "Outer border error. Correct and upload again";
                hasError = true;
              }
              if (i === 2 || i === lines.length) {
                const samplecharacters = line.split(" ");
                if (samplecharacters.length !== b) {
                  // There should be b characters separated by a space
                  console.log("Incorrect number of columns");
                  errortext = "Incorrect width. Correct and upload again";
                  hasError = true;
                }
                for (let j = 0; j < samplecharacters.length; j++) {
                  if (samplecharacters[j] !== "#") {
                    console.log("border error");
                    errortext = "Border error. Correct and upload again";
                    hasError = true;
                  }
                }
              }
              // Verify characters separated by space are valid
              if (i !== 2 && i !== lines.length - 1) {
                const characters = line.split(" ");
                for (let j = 0; j < characters.length; j++) {
                  if (i === 2 || i === lines.length - 1) {
                    const characters = line.split(" ");
                    for (let j = 0; j < characters.length; j++) {
                      if (characters[j] !== "#" && characters.length != b) {
                        console.log("border error");
                        errortext = "Border error. Correct and upload again";
                        hasError = true;
                      }
                    }
                  }
                  const character = characters[j];
                  if (character == "+") {
                    plusno++;
                  }
                  if (character == "-") {
                    minusno++;
                  }
                  if (characters[j] === "+") {
                    if (
                      characters[j - 1] === "+" ||
                      characters[j + 1] === "+"
                    ) {
                    } else {
                      if (plusno > 1) {
                        console.log("plus swarms not linked");
                        errortext = "Swarm error. Correct and upload again";
                        hasError = true;
                      }
                    }
                  }

                  if (characters[j] === "-") {
                    if (
                      characters[j - 1] === "-" ||
                      characters[j + 1] === "-"
                    ) {
                    } else {
                      if (minusno > 1) {
                        console.log("minus swarms not linked");
                        errortext = "Swarm error. Correct and upload again";
                        hasError = true;
                      }
                    }
                  }

                  if (!/^[\d#.+\\-]$/.test(character)) {
                    // Only allow #, digits, ., +, -
                    console.log("out of bounds");
                    errortext = "Value out of bounds. Correct and upload again";
                    hasError = true;
                  }
                  if (character === "+") {
                    hasPlus = true;
                  } else if (character === "-") {
                    hasMinus = true;
                  } else if (/^[1-9]$/.test(character)) {
                    // Verify that a number from 1 to 9 is separated by space
                    if (j === 0 || j === characters.length - 1) {
                      console.log("number out of bounds");
                      errortext = "Value out of bounds. Correct and upload again";
                      hasError = true;
                    }
                    /*
                 const previousCharacter = characters[j - 1];
                  const nextCharacter = characters[j + 1];
                  if (previousCharacter !== '.' && previousCharacter !== '-') {
                    console.log("spacing error");
                  }
                  if (nextCharacter !== '.' && nextCharacter !== '+') {
                    console.log("spacing error");
                  }*/
                  } else {
                    // Any other character separated by space is considered an error
                    // console.log("ou of bounds");
                  }
                }
              }
            }
            if (plusno === 0 || minusno === 0) {
              console.log("swarm error");
              errortext = "Swarm error. Correct and upload again";
              hasError = true;
            }
            if (!plusFound || !minusFound) {
              //console.log("swarms missing");
            }
            if (hasError) {
              successMessage.style.display='none';
  errorMessage.style.display = 'flex';
              errortxt.innerHTML = errortext;
              } else {
              errorMessage.style.display = 'none';
              successMessage.style.display='flex';
  }
          },
          false
        );

        // reads the file as text
        if (file) {
          reader.readAsText(file);
          const contents = reader.result;
          console.log("read content");
        }
        inp.value = '';

      }



      function saveIterations(inp) {
        localStorage.setItem(inp.id, inp.value); // save contents to localStorage
        const uploadedFileContents = localStorage.getItem(inp.id);
        console.log(uploadedFileContents);
      }

      function saveLog(inp) {
        localStorage.setItem(inp.id, inp.checked); // save contents to localStorage
        const uploadedFileContents = localStorage.getItem(inp.id);
        console.log(uploadedFileContents);
      }

      console.log(localStorage.getItem("map"));
    </script>
</body>

</html>