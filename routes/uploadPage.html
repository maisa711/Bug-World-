<!DOCTYPE html>
<html>

<head>
  <title>File Upload Page</title>
  <link rel="stylesheet" type="text/css" href="../css/uploadPage.css" />
  <link rel="stylesheet" type="text/css" href="../css/app.css" />
  <script src="https://kit.fontawesome.com/19094358f0.js" crossorigin="anonymous"></script>
</head>

<body>
  <section class="header">
    <headtext>Upload files to create your own</headtext>
    <a href="uploadPage.html">
      <headerlogo><img src="buglogo.svg"></headerlogo>
    </a>
  </section>
  <section class="formsection">

    <form action="mainPage.html" method="post">
      <div class="mainDiv">
        <div class="inpDiv">
          <label for="divfile1">Please upload the world map:</label>
          <div class="uploadFile" id="divfile1">
            <label for="map">
              <i class="fa-solid fa-file-arrow-up fa-2x"></i>
            </label>
            <input id="map" type="file" onchange="SaveFile(this)" />
            <section id="errsection1" class="errsection1">
              <div id="error-message1" style="display:none">
                <i class="fa-solid fa-circle-xmark fa-2x"></i>
                <div id="errortxt1">Error in file</div>
              </div>
            </section>
            <section id="successsection1" class="successsection1">
              <div id="success-message1" style="display:none">
                <i class="fa-solid fa-circle-check fa-2x"></i>
                <div id="successtxt1">0 errors detected.</div>
              </div>
            </section>
          </div>
        </div>

        <div class="inpDiv">
          <label for="divfile2">Please upload the bug code 1:</label>
          <div class="uploadFile" id="divfile2">
            <label for="bugCode1">
              <i class="fa-solid fa-file-arrow-up fa-2x"></i>
            </label>

            <input id="bugCode1" type="file" onchange="saveBug1(this)" />
            <section id="errsection2" class="errsection2">
              <div id="error-message2" style="display:none">
                <i class="fa-solid fa-circle-xmark fa-2x"></i>
                <div id="errortxt2">Error in file</div>
              </div>
            </section>
            <section id="successsection2" class="successsection2">
              <div id="success-message2" style="display:none">
                <i class="fa-solid fa-circle-check fa-2x"></i>
                <div id="successtxt2">0 errors detected.</div>
              </div>
            </section>
          </div>
        </div>

        <div class="inpDiv">
          <label for="divfile3">Please upload the bug code 2:</label>
          <div class="uploadFile" id="divfile3">
            <label for="bugCode2">
              <i class="fa-solid fa-file-arrow-up fa-2x"></i>
            </label>

            <input id="bugCode2" type="file" onchange="saveBug2(this)" />
            <section id="errsection3" class="errsection3">
              <div id="error-message3" style="display:none">
                <i class="fa-solid fa-circle-xmark fa-2x"></i>
                <div id="errortxt3">Error in file</div>
              </div>
            </section>
            <section id="successsection3" class="successsection3">
              <div id="success-message3" style="display:none">
                <i class="fa-solid fa-circle-check fa-2x"></i>
                <div id="successtxt3">0 errors detected.</div>
              </div>
            </section>
          </div>

          <div class="inpDiv">
            <label for="numIterations">Please enter the number of iterations:</label>
            <input type="number" id="numIterations" onchange="saveIterations(this)" />
          </div>

          <div class="inpDiv">
            <label for="actLog">Do you want to log the results of the session:
            </label>
            <input type="checkbox" id="actLog" onchange="saveLog(this)" />
          </div>

          <button type="submit" class="upBtn">Upload Files</button>
        </div>
    </form>

    <script>



      function saveIterations(inp) {
        localStorage.setItem(inp.id, inp.value); // save contents to localStorage
        const uploadedFileContents = localStorage.getItem(inp.id);
        console.log(uploadedFileContents);
      }

      function saveLog(inp) {
        localStorage.setItem(inp.id, inp.checked); // save contents to localStorage
        const uploadedFileContents = localStorage.getItem(inp.id);
        console.log(uploadedFileContents);
      }

      console.log(localStorage.getItem("map"));

      function saveBug(inp) {
        // regex for each command, to determine the format of the commands
        // example of the sense command format
        // sense ahead 1 3 food; after semi-colon everything is a comment
        const sense = /^sense (here|ahead|leftahead|rightahead) \d+ \d+ (friend|foe|friendwithfood|foewithfood|food|rock|marker|foemarker|home|foehome);.*$/;
        const mark = /^mark \d+ \d+;.*$/;
        const unmark = /^unmark \d+ [\d+];.*$/;
        const pickup = /^pickup \d+ \d+;.*$/;
        const drop = /^drop \d+;.*$/;
        const turn = /^turn (left|right) \d+;.*$/;
        const move = /^move \d+ \d+;.*$/;
        const flip = /^flip \d+ \d+ \d+;.*$/;

        // regex if there is only a comment
        const comment = /^;.*$/;

        // get the file from the input element
        const file = inp.files[0];

        // create a new FileReader object
        const reader = new FileReader();

        // add an event listener to deal with the file when the reader is done
        reader.addEventListener(
          "load",
          function (event) {
            //grab file's text
            const text = reader.result;

            const lines = text.split("\r\n");

            // create an object to store the instructions
            let bugCode = {};

            // loop through each line of the instrucions, check if it is a valid instuction, and add it to the object
            lines.forEach((line, i) => {
              line = line.trim();

              // check if the line has commands or is it just a comment
              if (comment.test(line)) {
                throw "lack of commands"
              } else {
                // check if the line has a vaild format
                if (sense.test(line) || mark.test(line) || unmark.test(line) || pickup.test(line) || drop.test(line) || turn.test(line) || move.test(line) || flip.test(line)) {
                  onlyComments = false;

                  line = line.split(";");

                  // get the instruction value
                  let value = line[0];

                  //if evething is good, add the instruction to the object
                  // key is the index of the line and the value is the instruction
                  bugCode[i] = value;
                } else {
                  console.log("incorrect syntax");
//                  throw "incorrect syntax";
                }
              }
            });

            // check if the instructions link to a non-existent line

            let bugCodeLen = Object.keys(bugCode).length - 1;

            for (const [key, value] of Object.entries(bugCode)) {
              let nums = value.match(/\b\d+\b/g);

              nums.forEach((num) => {
                if (num > bugCodeLen) {
                  throw "link to a non-existent line";
                }
              });
            }

            console.log("all good");

            // get the file name
            let fileName = inp.value
              .split(/(\\|\/)/g)
              .pop()
              .split(".")[0];

            //save file to localStorage, key is the id of the input element
            //object is converted to a string
            //to convert back to an object, use JSON.parse(object)
            localStorage.setItem(fileName + "_bug", JSON.stringify(bugCode));
            console.log(JSON.parse(localStorage.getItem("Red_bug")));
          },
          false
        );

        // reads the file as text
        if (file) {
          reader.readAsText(file);
        }
      }

    </script>
  <script src="../js/uploadPage.js"></script>

</body>

</html>